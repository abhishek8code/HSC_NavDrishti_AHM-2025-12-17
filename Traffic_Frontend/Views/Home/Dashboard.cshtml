@{
    ViewData["Title"] = "Traffic Dashboard";
}

<style>
    /* Responsive adjustments */
    @@media (max-width: 576px) {
        .container-fluid { padding: 0.75rem !important; }
        .card-header h5 { font-size: 1rem; }
        h2 { font-size: 1.5rem; }
    }
</style>

<div class="container-fluid p-3 p-sm-4">
    <div id="backendStatusBanner" class="alert alert-warning d-none" role="alert">
        Backend unavailable at <code>@(ViewBag.BackendApiUrl ?? "http://localhost:8000")</code>. Some features may not load. Retry after starting backend.
    </div>

    <h2 class="mb-3"><i class="bi bi-speedometer2"></i> Traffic Control Dashboard</h2>

    <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-4">
        <div class="nav nav-pills" id="dashboardTabs">
            <button class="nav-link active" data-tab="overview" type="button"><i class="bi bi-clipboard-data"></i> Overview</button>
            <button class="nav-link" data-tab="traffic" type="button"><i class="bi bi-activity"></i> Traffic</button>
            <button class="nav-link" data-tab="ai" type="button"><i class="bi bi-robot"></i> AI</button>
            <button class="nav-link" data-tab="projects" type="button"><i class="bi bi-folder"></i> Projects</button>
        </div>
        <a class="btn btn-outline-primary btn-sm" href="/Operations"><i class="bi bi-map"></i> Open Operations Center</a>
    </div>

    <div id="dashboardTabContent">
        <div class="tab-section" data-tab="overview">
            <!-- Overview Metrics -->
            <div class="row mb-4">
                <div class="col-12 col-sm-6 col-lg-4 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted mb-3">Active Projects</h5>
                            <h2 class="mb-0" id="activeProjects">@(ViewBag.Projects?.Count ?? 0)</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-4 mb-3">
                    <div class="card shadow-sm h-100 border-danger">
                        <div class="card-body">
                            <h5 class="card-title text-muted mb-3">Critical Alerts</h5>
                            <h2 class="mb-0 text-danger" id="criticalAlerts">0</h2>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-sm-6 col-lg-4 mb-3">
                    <div class="card shadow-sm h-100">
                        <div class="card-body">
                            <h5 class="card-title text-muted mb-3">CO2 Saved</h5>
                            <h2 class="mb-0 text-success" id="co2Saved">0 kg</h2>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Project Creation Link -->
            <div class="alert alert-info d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
                <div>
                    <strong>Route Selection & Live Map:</strong> Create projects and view real-time traffic on the dedicated page.
                </div>
                <a class="btn btn-primary" href="@Url.Action("ProjectCreation","Home")">
                    <i class="bi bi-box-arrow-right"></i> Go to Project Creation
                </a>
            </div>
        </div>

    <div class="tab-section d-none" data-tab="ai">
    <!-- AI Model Information -->
    <div class="card shadow-sm mb-4">
        <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h5 class="mb-0"><i class="bi bi-cpu"></i> AI Model Information</h5>
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6 mb-3">
                    <h6 class="text-primary">Model Details</h6>
                    <table class="table table-sm">
                        <tr><td><strong>Algorithm:</strong></td><td id="aiModel">Random Forest Regressor</td></tr>
                        <tr><td><strong>Training Data:</strong></td><td id="aiTrainingSize">10,000+ samples</td></tr>
                        <tr><td><strong>Accuracy:</strong></td><td id="aiAccuracy">94.2%</td></tr>
                        <tr><td><strong>Last Updated:</strong></td><td id="aiLastUpdate">Nov 30, 2025</td></tr>
                    </table>
                </div>
                <div class="col-md-6 mb-3">
                    <h6 class="text-primary">Features Used</h6>
                    <ul class="list-unstyled">
                        <li><i class="bi bi-check-circle text-success"></i> Historical traffic patterns</li>
                        <li><i class="bi bi-check-circle text-success"></i> Time of day & day of week</li>
                        <li><i class="bi bi-check-circle text-success"></i> Weather conditions</li>
                        <li><i class="bi bi-check-circle text-success"></i> Road segment characteristics</li>
                        <li><i class="bi bi-check-circle text-success"></i> Special events calendar</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Speed Recommendations -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-speedometer"></i> AI Speed Recommendations</h5>
        </div>
        <div class="card-body">
            <div id="aiRecommendationsContainer">
                <div class="row">
                    <div class="col-md-4 mb-3">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Optimal Speed (Current)</h6>
                                <h3 class="text-success mb-0" id="optimalSpeed">45 km/h</h3>
                                <small class="text-muted">For minimum congestion</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card border-warning">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Predicted Speed (1h)</h6>
                                <h3 class="text-warning mb-0" id="predictedSpeed1h">38 km/h</h3>
                                <small class="text-muted">Expected in 1 hour</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-3">
                        <div class="card border-danger">
                            <div class="card-body text-center">
                                <h6 class="text-muted">Peak Hour Speed</h6>
                                <h3 class="text-danger mb-0" id="peakSpeed">28 km/h</h3>
                                <small class="text-muted">During rush hours</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Predictions -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0"><i class="bi bi-robot"></i> AI Traffic Predictions</h5>
        </div>
        <div class="card-body">
            <h6 class="mb-3">Speed Forecast (Next 4 Hours)</h6>
            <div style="position: relative; height: 300px;">
                <canvas id="aiPredictionChart" style="width:100%; height:100%;"></canvas>
            </div>
            <div class="alert alert-info mt-3">
                <i class="bi bi-info-circle"></i> <strong>AI Insight:</strong> Traffic is expected to increase during the next hour. Consider alternative routes for time-sensitive deliveries.
            </div>
        </div>
    </div>

    </div> <!-- /tab-section ai -->

    <!-- Analytics Charts -->
    <div class="tab-section d-none" data-tab="traffic">
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-dark text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up"></i> Traffic Analytics</h5>
        </div>
        <div class="card-body">
            <h6 class="mb-3">24-Hour Traffic Trends</h6>
            <div class="mb-4" style="position: relative; height: 300px;">
                <canvas id="trafficTrendChart" style="width:100%; height:100%;"></canvas>
            </div>
            <h6 class="mb-3">Congestion Distribution</h6>
            <div class="mb-3" style="position: relative; height: 300px;">
                <canvas id="speedProfilesChart" style="width:100%; height:100%;"></canvas>
            </div>
        </div>
    </div>

    </div> <!-- /tab-section traffic -->

    <div class="tab-section d-none" data-tab="projects">
        <!-- Alternative Routes -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="bi bi-signpost-split"></i> Alternative Routes Analysis</h5>
            </div>
            <div class="card-body">
                <div id="alternativesContainer">
                    <p class="text-muted">Select a route from the Project Creation page to view AI-powered alternative route suggestions here.</p>
                </div>
                <a class="btn btn-outline-primary btn-sm mt-3" href="/Projects"><i class="bi bi-folder"></i> Go to Project Manager</a>
            </div>
        </div>
    </div>

    <div class="tab-section d-none" data-tab="traffic">
    <!-- Traffic Alerts -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-danger text-white d-flex flex-column flex-sm-row justify-content-between align-items-start align-items-sm-center gap-2">
            <h5 class="mb-0"><i class="bi bi-exclamation-triangle"></i> Traffic Alerts</h5>
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="alertsToggle" checked>
                <label class="form-check-label text-white" for="alertsToggle">Show Alerts</label>
            </div>
        </div>
        <div class="card-body" id="trafficAlertsContent">
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-circle"></i> <strong>Heavy Traffic:</strong> S.G. Highway near Prahladnagar - Expected delay 15-20 minutes
            </div>
            <div class="alert alert-danger">
                <i class="bi bi-cone-striped"></i> <strong>Road Work:</strong> Ashram Road - Lane closure active until 6 PM
            </div>
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> <strong>Event Traffic:</strong> Cricket match at Motera Stadium - Heavy congestion expected 5-8 PM
            </div>
        </div>
    </div>

    <!-- Traffic Statistics -->
    <div class="card shadow-sm mb-4">
        <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Real-Time Traffic Statistics</h5>
        </div>
        <div class="card-body">
            <div class="row text-center mb-3">
                <div class="col-md-4 mb-3">
                    <div class="card border-warning">
                        <div class="card-body">
                            <small class="text-muted">Average Congestion</small>
                            <h3 id="avgCongestion" class="text-warning mb-0">Medium</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-info">
                        <div class="card-body">
                            <small class="text-muted">Average Speed</small>
                            <h3 id="avgSpeed" class="text-info mb-0">42 km/h</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-4 mb-3">
                    <div class="card border-primary">
                        <div class="card-body">
                            <small class="text-muted">Active Vehicles</small>
                            <h3 id="totalVehicles" class="text-primary mb-0">1,250</h3>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-2">
                <small class="text-muted"><strong>Traffic Level Legend:</strong></small>
                <div class="d-flex justify-content-around mt-2">
                    <span><span style="display:inline-block; width:20px; height:20px; background:#22c55e; border-radius:4px;"></span> Low</span>
                    <span><span style="display:inline-block; width:20px; height:20px; background:#eab308; border-radius:4px;"></span> Medium</span>
                    <span><span style="display:inline-block; width:20px; height:20px; background:#ef4444; border-radius:4px;"></span> High</span>
                    <span><span style="display:inline-block; width:20px; height:20px; background:#991b1b; border-radius:4px;"></span> Critical</span>
                </div>
            </div>
        </div>
    </div>
    </div> <!-- /tab-section traffic (alerts + stats) -->

</div>

@section Scripts {
    <!-- Chart.js for comparisons -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- Dashboard Charts Initialization -->
    <script>
    (function() {
        const BACKEND_URL = '@(ViewBag.BackendApiUrl ?? "http://localhost:8002")';
        let trafficTrendChart, speedProfilesChart, aiPredictionChart;

        document.addEventListener('DOMContentLoaded', function() {
            initCharts();
            loadDashboardData();
        });

        function initCharts() {
            // Traffic Trend Chart
            const trendCtx = document.getElementById('trafficTrendChart');
            if (trendCtx) {
                trafficTrendChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Avg Speed (km/h)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        }, {
                            label: 'Vehicles',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top' }
                        },
                        scales: {
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: { display: true, text: 'Speed (km/h)' }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: { display: true, text: 'Vehicles' },
                                grid: { drawOnChartArea: false }
                            }
                        }
                    }
                });
            }

            // Speed Profiles Chart (Congestion Distribution)
            const speedCtx = document.getElementById('speedProfilesChart');
            if (speedCtx) {
                speedProfilesChart = new Chart(speedCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Low', 'Medium', 'High', 'Peak'],
                        datasets: [{
                            label: 'Hours',
                            data: [0, 0, 0, 0],
                            backgroundColor: [
                                'rgba(75, 192, 192, 0.6)',
                                'rgba(255, 206, 86, 0.6)',
                                'rgba(255, 159, 64, 0.6)',
                                'rgba(255, 99, 132, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Hours' } }
                        }
                    }
                });
            }

            // AI Prediction Chart
            const aiCtx = document.getElementById('aiPredictionChart');
            if (aiCtx) {
                aiPredictionChart = new Chart(aiCtx, {
                    type: 'line',
                    data: {
                        labels: ['Now', '+1h', '+2h', '+3h', '+4h'],
                        datasets: [{
                            label: 'Predicted Speed',
                            data: [45, 42, 38, 35, 40],
                            borderColor: 'rgb(153, 102, 255)',
                            backgroundColor: 'rgba(153, 102, 255, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true }
                        },
                        scales: {
                            y: { beginAtZero: true, title: { display: true, text: 'Speed (km/h)' } }
                        }
                    }
                });
            }
        }

        async function loadDashboardData() {
            try {
                // Load Traffic Trends
                const trendsRes = await fetch(`${BACKEND_URL}/analytics/traffic-trends?hours=24`);
                if (trendsRes.ok) {
                    const trends = await trendsRes.json();
                    updateTrafficTrend(trends);
                    updateCongestionDist(trends);
                }

                // Load AI Predictions (mock for now)
                loadAIPredictions();

                console.log('âœ“ Dashboard data loaded');
            } catch (err) {
                console.error('Dashboard data error:', err);
            }
        }

        function updateTrafficTrend(trends) {
            if (!trafficTrendChart || !trends.length) return;
            trends.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
            
            const labels = trends.map(t => {
                const d = new Date(t.timestamp);
                return d.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
            });
            const speeds = trends.map(t => t.avg_speed);
            const counts = trends.map(t => t.vehicle_count);

            trafficTrendChart.data.labels = labels;
            trafficTrendChart.data.datasets[0].data = speeds;
            trafficTrendChart.data.datasets[1].data = counts;
            trafficTrendChart.update();
        }

        function updateCongestionDist(trends) {
            if (!speedProfilesChart || !trends.length) return;
            
            const dist = { low: 0, medium: 0, high: 0, peak: 0 };
            trends.forEach(t => {
                const state = (t.congestion_state || 'low').toLowerCase();
                if (dist.hasOwnProperty(state)) dist[state]++;
            });

            speedProfilesChart.data.datasets[0].data = [
                dist.low, dist.medium, dist.high, dist.peak
            ];
            speedProfilesChart.update();
        }

        function loadAIPredictions() {
            // Mock AI predictions - replace with actual endpoint when available
            if (!aiPredictionChart) return;
            
            const now = new Date();
            const labels = [];
            const predictions = [];
            
            for (let i = 0; i <= 4; i++) {
                const time = new Date(now.getTime() + i * 60 * 60 * 1000);
                labels.push(time.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }));
                // Simple mock: decreasing speed during peak hours
                const baseSpeed = 45;
                const hourlyVariation = Math.sin(i * 0.5) * 10;
                predictions.push(Math.max(20, baseSpeed + hourlyVariation));
            }

            aiPredictionChart.data.labels = labels;
            aiPredictionChart.data.datasets[0].data = predictions;
            aiPredictionChart.update();
        }

        // Refresh every 5 minutes
        setInterval(loadDashboardData, 5 * 60 * 1000);
    })();
    </script>

    <!-- Pass tokens & backend URL early -->
    <script>
        window.MAPBOX_ACCESS_TOKEN = '@ViewBag.MapboxAccessToken';
        window.BACKEND_API_URL = '@(ViewBag.BackendApiUrl ?? "http://localhost:8002")';
        window.ENABLE_TRAFFIC_POLL = false;
        window.DEV_PERSIST_PROJECTS = false;
        (function(){
            var projects = @((ViewBag.Projects != null) ? "true" : "false");
            if(projects === false){
                var banner = document.getElementById('backendStatusBanner');
                if(banner){ banner.classList.remove('d-none'); }
            }
        })();

        // Simple tab controller for dashboard
        document.addEventListener('DOMContentLoaded', function(){
            var tabs = document.querySelectorAll('#dashboardTabs .nav-link');
            var sections = document.querySelectorAll('.tab-section');

            function showTab(name){
                sections.forEach(function(sec){
                    var isMatch = sec.dataset.tab === name;
                    sec.classList.toggle('d-none', !isMatch);
                });
                tabs.forEach(function(btn){
                    btn.classList.toggle('active', btn.dataset.tab === name);
                });
            }

            tabs.forEach(function(btn){
                btn.addEventListener('click', function(){
                    showTab(btn.dataset.tab);
                });
            });

            // Default tab
            showTab('overview');
        });
    </script>
}

