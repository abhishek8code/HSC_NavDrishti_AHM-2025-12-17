@{
    ViewData["Title"] = "Traffic Dashboard";
}

<div class="container-fluid p-3">
    <div id="backendStatusBanner" class="alert alert-warning d-none" role="alert">
        Backend unavailable at <code>@(ViewBag.BackendApiUrl ?? "http://localhost:8000")</code>. Some features may not load. Retry after starting backend.
    </div>

    <!-- Top Row: 3-Column Metrics -->
    <div class="row mb-3">
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-3">Active Projects</h5>
                    <h2 class="mb-0" id="activeProjects">@(ViewBag.Projects?.Count ?? 0)</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100 border-danger">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-3">Critical Alerts</h5>
                    <h2 class="mb-0 text-danger" id="criticalAlerts">0</h2>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm h-100">
                <div class="card-body">
                    <h5 class="card-title text-muted mb-3">CO2 Saved</h5>
                    <h2 class="mb-0 text-success" id="co2Saved">0 kg</h2>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Row: Left stacked panels + Right map-only -->
    <div class="row">
        <div class="col-md-3">
            <!-- Route Selection (top) -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Route Selection</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2 mb-3">
                        <button id="startDrawingBtn" class="btn btn-success">
                            <i class="bi bi-pencil"></i> Draw Route on Map
                        </button>
                        <button id="clickSelectBtn" class="btn btn-outline-primary">
                            <i class="bi bi-mouse-pointer"></i> Click Select Route
                        </button>
                        <button id="clearRouteBtn" class="btn btn-outline-danger" disabled>
                            <i class="bi bi-trash"></i> Clear Route
                        </button>
                    </div>

                    <div id="routeInfoPanel" class="border rounded p-3 bg-light d-none">
                        <h6 class="fw-bold mb-2">Route Information</h6>
                        <div class="mb-2"><strong>Length:</strong> <span id="routeLength">-</span> km</div>
                        <div class="mb-2"><strong>Points:</strong> <span id="routePoints">-</span></div>
                        <div class="mb-2"><strong>Road Type:</strong> <span id="roadType">-</span></div>
                        <div class="mb-2"><strong>Road Width:</strong> <span id="roadWidth">-</span> m</div>
                        <div class="mb-2"><strong>Lanes:</strong> <span id="roadLanes">-</span></div>
                        <hr>
                        <h6 class="fw-bold mb-2">Traffic Analysis</h6>
                        <div class="mb-2"><strong>Total Vehicles:</strong> <span id="vehicleCount">-</span></div>
                        <div class="small">
                            <div><strong>Two Wheeler:</strong> <span id="twoWheelerCount">-</span></div>
                            <div><strong>Four Wheeler:</strong> <span id="fourWheelerCount">-</span></div>
                            <div><strong>Heavy (Bus/Truck):</strong> <span id="heavyVehicleCount">-</span></div>
                        </div>
                        <hr>
                        <div class="d-grid">
                            <button id="createProjectFromRoute" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Create Project
                            </button>
                        </div>
                    </div>

                    <div id="selectionHint" class="text-muted small mt-2">Click "Draw Route" then click points on the map to create a construction route.</div>
                </div>
            </div>

            <!-- Projects -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white"><h5 class="mb-0">Projects</h5></div>
                <div class="card-body"><div id="projectsList"><p class="text-muted">Loading projects...</p></div></div>
            </div>

            <!-- Alternatives -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-warning text-dark"><h5 class="mb-0">Alternatives (Ranked)</h5></div>
                <div class="card-body">@await Html.PartialAsync("~/Views/Shared/_AlternativesPanel.cshtml")</div>
            </div>

            <!-- Scenario Compare -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-secondary text-white"><h5 class="mb-0">Scenario Compare</h5></div>
                <div class="card-body">@await Html.PartialAsync("~/Views/Shared/_ScenarioPanel.cshtml")</div>
            </div>

            <!-- Traffic Alerts -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-danger text-white"><h5 class="mb-0">Traffic Alerts</h5></div>
                <div class="card-body" id="trafficAlertsPanel"><p class="text-muted">Waiting for live traffic updates...</p></div>
            </div>
        </div>

        <!-- Right: Map-only column -->
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Map</h5>
                    <div>
                        <span id="mapStatusBadge" class="badge bg-secondary">Map: initializing</span>
                    </div>
                </div>
                <div class="card-body p-0"><div id="dashboardMap" style="width:100%; height:85vh;"></div></div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Mapbox GL Draw -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css' type='text/css' />

    <!-- Turf.js -->
    <script src='https://cdn.jsdelivr.net/npm/@@turf/turf@7/turf.min.js'></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- API Client and Traffic helpers -->
    <script src="~/js/apiClient.js"></script>
    <script src="~/js/trafficLineRenderer.js?v=2"></script>
    <script src="~/js/trafficOverlay.js?v=2"></script>

    <!-- Pass tokens & backend URL early -->
    <script>
        window.MAPBOX_ACCESS_TOKEN = '@ViewBag.MapboxAccessToken';
        window.BACKEND_API_URL = '@(ViewBag.BackendApiUrl ?? "http://localhost:8001")';
        // Disable traffic polling by default to avoid backend 404 spam; set to true to enable
        window.ENABLE_TRAFFIC_POLL = false;
        (function(){
            var projects = @((ViewBag.Projects != null) ? "true" : "false");
            if(projects === false){
                var banner = document.getElementById('backendStatusBanner');
                if(banner){ banner.classList.remove('d-none'); }
            }
        })();
    </script>

    <!-- Dashboard map first, then route selection -->
    <script src="~/js/dashboard.js?v=2"></script>
    <script src="~/js/routeSelection.js?v=3"></script>
    <script src="~/js/scenarioCompare.js?v=2"></script>
}

