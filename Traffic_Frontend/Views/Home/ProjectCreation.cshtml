@{
    ViewData["Title"] = "Project Creation";
}

<div class="container-fluid p-3">
    <div id="backendStatusBanner" class="alert alert-warning d-none" role="alert">
        Backend unavailable at <code>@(ViewBag.BackendApiUrl ?? "http://localhost:8002")</code>. Some features may not load. Start the backend and retry.
    </div>

    <div class="row g-3">
        <!-- Left: Route Selection + Projects -->
        <div class="col-md-3">
            <!-- Route Selection -->
            <div class="card shadow-sm mb-3" style="min-height: 600px;">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">Route Selection</h5>
                </div>
                <div class="card-body" style="max-height: 550px; overflow-y: auto;">
                    <div class="d-grid gap-2 mb-3">
                        <button id="startDrawingBtn" class="btn btn-success">
                            <i class="bi bi-pencil"></i> Draw Route on Map
                        </button>
                        <button id="clickSelectBtn" class="btn btn-outline-primary">
                            <i class="bi bi-mouse-pointer"></i> Click Select Route
                        </button>
                        <button id="clearRouteBtn" class="btn btn-outline-danger" disabled>
                            <i class="bi bi-trash"></i> Clear Route
                        </button>
                    </div>

                    <div id="routeInfoPanel" class="border rounded p-3 bg-light d-none">
                        <h6 class="fw-bold mb-2">Route Information</h6>
                        <div class="mb-2"><strong>Length:</strong> <span id="routeLength">-</span> km</div>
                        <div class="mb-2"><strong>Points:</strong> <span id="routePoints">-</span></div>
                        <div class="mb-2"><strong>Road Type:</strong> <span id="roadType">-</span></div>
                        <div class="mb-2"><strong>Road Width:</strong> <span id="roadWidth">-</span> m</div>
                        <div class="mb-2"><strong>Lanes:</strong> <span id="roadLanes">-</span></div>
                        <div class="mb-3">
                            <label class="form-label small fw-bold" for="projectDaysInput">
                                <i class="bi bi-calendar-check"></i> Number of Days of Construction
                            </label>
                            <input id="projectDaysInput" type="number" class="form-control form-control-sm" value="30" min="1" max="365" step="1" placeholder="Enter days">
                            <div class="form-text">Used to monitor construction progress and set project completion deadline.</div>
                        </div>
                        <hr>
                        <h6 class="fw-bold mb-2">Traffic Analysis</h6>
                        <div class="mb-2"><strong>Total Vehicles:</strong> <span id="vehicleCount">-</span></div>
                        <div class="small">
                            <div><strong>Two Wheeler:</strong> <span id="twoWheelerCount">-</span></div>
                            <div><strong>Four Wheeler:</strong> <span id="fourWheelerCount">-</span></div>
                            <div><strong>Heavy (Bus/Truck):</strong> <span id="heavyVehicleCount">-</span></div>
                        </div>
                        <hr>
                        <div class="d-grid">
                            <button id="createProjectFromRoute" class="btn btn-primary">
                                <i class="bi bi-plus-circle"></i> Create Project
                            </button>
                        </div>
                    </div>

                    <div id="selectionHint" class="text-muted small mt-2">Click "Draw Route" then click points on the map to create a construction route.</div>
                </div>
            </div>

            <!-- Projects -->
            <div class="card shadow-sm mb-3">
                <div class="card-header bg-success text-white"><h5 class="mb-0">Projects</h5></div>
                <div class="card-body">
                    <div id="projectsList">
                        @if (ViewBag.Projects != null && ViewBag.Projects.Count > 0)
                        {
                            <ul class="list-group">
                                @foreach (var p in ViewBag.Projects)
                                {
                                    <li class="list-group-item d-flex justify-content-between align-items-center">
                                        <span>@p.Name</span>
                                        <span class="badge bg-secondary">@p.Id</span>
                                    </li>
                                }
                            </ul>
                        }
                        else
                        {
                            <p class="text-muted">Loading projects...</p>
                        }
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Live Map -->
        <div class="col-md-9">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Live Map</h5>
                    <div>
                        <span id="mapStatusBadge" class="badge bg-secondary">Map: initializing</span>
                    </div>
                </div>
                <div class="card-body p-0" style="position: relative;">
                    <div id="dashboardMap" style="width:100%; height:80vh;"></div>

                    <!-- Alternatives Panel (overlay) -->
                    <div id="altRoutesPanel" class="position-absolute top-0 end-0 m-3" style="width: 320px; max-height: 70vh; overflow-y: auto; display: none;">
                        <div class="card shadow">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <span><i class="bi bi-signpost-split"></i> Alternative Routes</span>
                                <button type="button" class="btn btn-sm btn-outline-secondary" id="hideAltPanel">Hide</button>
                            </div>
                            <div class="card-body p-2" id="altRoutesList">
                                <div class="alert alert-info p-2 small mb-0">
                                    Draw a route to see alternatives
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Alternative Info (overlay) -->
                    <div id="selectedAltInfo" class="position-absolute bottom-0 start-0 m-3" style="display: none;">
                        <div class="card shadow-sm" style="min-width: 280px;">
                            <div class="card-body p-2">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong id="selectedAltTitle">Alternative</strong>
                                    <span class="badge" id="selectedAltTraffic">Traffic</span>
                                </div>
                                <div class="small text-muted mt-1" id="selectedAltMetrics">—</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Mapbox GL Draw -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css' type='text/css' />

    <!-- Turf.js -->
    <script src='https://cdn.jsdelivr.net/npm/@@turf/turf@7/turf.min.js'></script>

    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">

    <!-- API Client and helpers -->
    <script src="~/js/apiClient.js"></script>
    <script src="~/js/trafficLineRenderer.js?v=2"></script>
    <script src="~/js/trafficOverlay.js?v=3"></script>

    <!-- Mapbox tools -->
    <script src="~/js/addressSearch.js?v=1"></script>
    <script src="~/js/isochrone.js?v=1"></script>
    <script src="~/js/travelMatrix.js?v=1"></script>
    <script src="~/js/routeOptimizer.js?v=1"></script>

    <!-- Pass tokens & backend URL -->
    <script>
        window.MAPBOX_ACCESS_TOKEN = '@ViewBag.MapboxAccessToken';
        window.BACKEND_API_URL = '@(ViewBag.BackendApiUrl ?? "http://localhost:8002")';
        window.ENABLE_TRAFFIC_POLL = false;
        window.DEV_PERSIST_PROJECTS = true;
        (function(){
            var hasProjects = @((ViewBag.Projects != null) ? "true" : "false");
            if(hasProjects === false){
                var banner = document.getElementById('backendStatusBanner');
                if(banner){ banner.classList.remove('d-none'); }
            }
        })();
    </script>

    <!-- Initialize map and route selection -->
    <script src="~/js/dashboard.js?v=2"></script>
    <script src="~/js/routeSelection.js?v=3"></script>

    <script>
        // Toggle Alternatives panel visibility
        (function() {
            const panel = document.getElementById('altRoutesPanel');
            const list = document.getElementById('altRoutesList');
            const hideBtn = document.getElementById('hideAltPanel');
            const selectedInfo = document.getElementById('selectedAltInfo');
            const selectedTitle = document.getElementById('selectedAltTitle');
            const selectedTraffic = document.getElementById('selectedAltTraffic');
            const selectedMetrics = document.getElementById('selectedAltMetrics');

            if (hideBtn) {
                hideBtn.addEventListener('click', function() {
                    panel.style.display = 'none';
                });
            }

            function trafficBadgeClass(score) {
                if (score == null) return 'bg-secondary';
                if (score >= 0.7) return 'bg-success';
                if (score >= 0.4) return 'bg-warning';
                return 'bg-danger';
            }

            // Populate alternatives list when provided by routeSelection
            document.addEventListener('routes:alternatives', function(e) {
                try {
                    const detail = e.detail || {};
                    const routes = detail.allAlternatives || [];
                    if (!routes.length) {
                        list.innerHTML = '<div class="alert alert-info p-2 small mb-0">No alternatives found</div>';
                        panel.style.display = 'block';
                        return;
                    }

                    const html = routes.map(function(r, idx) {
                        const id = r.routeId || r.id || (idx + 1);
                        const dist = (r.distance_km || r.lengthKm || 0).toFixed(2);
                        const time = (r.travel_time_min || Math.round((r.lengthKm || 0) * 2));
                        const score = r.traffic_score != null ? r.traffic_score : (r.suitabilitySelect != null ? r.suitabilityScore : null);
                        const emission = r.emission_g || (r.distance_km ? Math.round(r.distance_km * 120) : null);
                        const turnCount = r.turn_count || 0;
                        const roadClasses = r.road_classes && r.road_classes.length ? r.road_classes.join(', ') : 'Standard';

                        return '<div class="card mb-2 border-0 shadow-sm">' +
                        '<div class="card-body p-2">' +
                            '<div class="d-flex justify-content-between align-items-center">' +
                                '<div>' +
                                    '<strong>Route ' + (idx + 1) + '</strong>' +
                                    '<div class="small text-muted">' + dist + ' km • ' + time + ' min</div>' +
                                    (emission ? '<div class="small text-muted">~' + emission + 'g CO₂</div>' : '') +
                                    (roadClasses !== 'Standard' ? '<div class="small text-info">Streets: ' + roadClasses + '</div>' : '') +
                                '</div>' +
                                '<div class="d-flex gap-1">' +
                                    '<button class="btn btn-sm btn-outline-primary" data-route="' + id + '" data-action="select">Select</button>' +
                                    '<button class="btn btn-sm btn-outline-secondary" data-route="' + id + '" data-action="details">Details</button>' +
                                '</div>' +
                            '</div>' +
                            (score != null ? '<div class="mt-1"><span class="badge ' + trafficBadgeClass(score) + '">Traffic ' + Math.round(score * 100) + '%</span></div>' : '') +
                            (turnCount > 0 ? '<div class="mt-1"><span class="badge bg-secondary">Turns: ' + turnCount + '</span></div>' : '') +
                        '</div>' +
                    '</div>';
                    }).join('');

                    list.innerHTML = html;
                    panel.style.display = 'block';
                } catch(err) { console.warn('alternatives render error', err); }
            });

            // Show selected alternative info
            document.addEventListener('routes:alternativeSelected', function(e) {
                try {
                    const route = (e.detail && e.detail.route) || {};
                    const dist = route.distance_km || (route.lengthKm || (route.raw && route.raw.distance_km));
                    const time = route.travel_time_min || (route.duration_min || Math.round((dist || 0) * 2));
                    const score = route.traffic_score != null ? route.traffic_score : (route.raw && route.raw.traffic_score);
                    const emission = route.emission_g || (dist ? dist * 120 : null);
                    const roadClasses = route.road_classes && route.road_classes.length ? route.road_classes.join(', ') : null;
                    const turnCount = route.turn_count || 0;

                    selectedTitle.textContent = 'Selected Route';
                    selectedTraffic.className = 'badge ' + trafficBadgeClass(score);
                    selectedTraffic.textContent = 'Traffic ' + (score != null ? Math.round(score * 100) + '%' : 'N/A');
                    
                    let metricsText = (dist ? dist.toFixed ? dist.toFixed(2) : dist : 'N/A') + ' km • ' + (time || 'N/A') + ' min';
                    if (emission) {
                        metricsText += ' • ' + Math.round(emission) + 'g CO₂';
                    }
                    if (turnCount > 0) {
                        metricsText += ' • ' + turnCount + ' turns';
                    }
                    if (roadClasses) {
                        metricsText += ' • Streets: ' + roadClasses;
                    }
                    selectedMetrics.textContent = metricsText;
                    selectedInfo.style.display = 'block';
                } catch(err) { console.warn('selection info error', err); }
            });
        })();
    </script>
}
